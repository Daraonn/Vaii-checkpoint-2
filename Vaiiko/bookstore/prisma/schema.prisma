generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id          Int       @id @default(autoincrement())
  name             String
  username         String?
  email            String    @unique
  password         String
  isAdmin          Boolean   @default(false)
  createdAt        DateTime  @default(now())
  bio              String?
  dateOfBirth      String?
  title            String?
  gender           String?
  avatar           String?
  
  favouriteBooks   FavouriteBook[]
  cartItems        CartItem[]
  ratings          Rating[]
  reviews          Review[]
  reviewComments   ReviewComment[]
  reviewLikes      ReviewLike[]
  followers        Follow[] @relation("Following")
  following        Follow[] @relation("Follower")
  alertsReceived   Alert[] @relation("AlertsReceived")
  alertsCreated    Alert[] @relation("AlertsCreated")
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  blockedUsers     Block[]   @relation("BlockedUsers")
  blockedBy        Block[]   @relation("BlockedBy")
  orders           Order[]
  threads          Thread[]
  threadComments   ThreadComment[]
  threadFollows    ThreadFollow[]
}

model Follow {
  follow_id       Int      @id @default(autoincrement())
  follower_id     Int
  following_id    Int
  createdAt       DateTime @default(now())
  
  follower        User @relation("Follower", fields: [follower_id], references: [user_id], onDelete: Cascade)
  following       User @relation("Following", fields: [following_id], references: [user_id], onDelete: Cascade)
  
  @@unique([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
}

model Book {
  book_id         Int     @id @default(autoincrement())
  name            String
  price           Int
  author          String
  ISBN            String  @unique
  image           String?

  about           String     
  language        String     
  year            Int 
          
  favouritedBy    FavouriteBook[]
  cartItems       CartItem[]
  genres          BookGenre[]
  ratings         Rating[]
  reviews         Review[]
  alerts          Alert[]
  orderItems      OrderItem[]
}

model FavouriteBook {
  favourite_id    Int      @id @default(autoincrement())
  user_id         Int
  book_id         Int
  addedAt         DateTime @default(now())

  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  book            Book @relation(fields: [book_id], references: [book_id], onDelete: Cascade)

  @@unique([user_id, book_id])
}

model CartItem {
  cart_item_id    Int      @id @default(autoincrement())
  user_id         Int
  book_id         Int
  quantity        Int      @default(1)  
  addedAt         DateTime @default(now())

  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  book            Book @relation(fields: [book_id], references: [book_id], onDelete: Cascade)

  @@unique([user_id, book_id]) 
}

model Order {
  order_id        Int      @id @default(autoincrement())
  user_id         Int
  
  
  fullName        String
  email           String
  phone           String?
  address         String
  city            String
  state           String?
  zipCode         String
  country         String?
  
  
  subtotal        Float
  shippingCost    Float
  tax             Float
  total           Float
  shippingMethod  String   @default("standard")
  
 
  status          OrderStatus @default(PENDING)
  
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  items           OrderItem[]
  
  @@index([user_id])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  order_item_id   Int      @id @default(autoincrement())
  order_id        Int
  book_id         Int
  quantity        Int
  price           Float    
  
  order           Order @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  book            Book @relation(fields: [book_id], references: [book_id], onDelete: Cascade)
  
  @@index([order_id])
  @@index([book_id])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model Rating {
  rating_id       Int      @id @default(autoincrement())
  user_id         Int
  book_id         Int
  stars           Int?
  status          ReadingStatus
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  book            Book @relation(fields: [book_id], references: [book_id], onDelete: Cascade)

  @@unique([user_id, book_id])
  @@index([book_id])
  @@index([user_id])
}

model Review {
  review_id       Int      @id @default(autoincrement())
  user_id         Int
  book_id         Int
  content         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  book            Book @relation(fields: [book_id], references: [book_id], onDelete: Cascade)
  comments        ReviewComment[]
  likes           ReviewLike[]
  alerts          Alert[]

  @@unique([user_id, book_id])
  @@index([book_id])
  @@index([user_id])
}

model ReviewComment {
  comment_id      Int      @id @default(autoincrement())
  review_id       Int
  user_id         Int
  content         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  review          Review @relation(fields: [review_id], references: [review_id], onDelete: Cascade)
  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  alerts          Alert[]
  @@index([review_id])
  @@index([user_id])
}

model ReviewLike {
  like_id         Int      @id @default(autoincrement())
  review_id       Int
  user_id         Int
  is_like         Boolean
  createdAt       DateTime @default(now())

  review Review @relation(fields: [review_id], references: [review_id], onDelete: Cascade)
  user   User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([review_id, user_id])
  @@index([review_id])
  @@index([user_id])
}

enum ReadingStatus {
  COMPLETED
  WANT_TO_READ
  CURRENTLY_READING
  DNF
}

model Genre {
  genre_id        Int    @id @default(autoincrement())
  name            String @unique

  books           BookGenre[]
}

model BookGenre {
  book_genre_id   Int @id @default(autoincrement())
  book_id         Int
  genre_id        Int

  book            Book  @relation(fields: [book_id], references: [book_id], onDelete: Cascade)
  genre           Genre @relation(fields: [genre_id], references: [genre_id], onDelete: Cascade)

  @@unique([book_id, genre_id])
}

model Message {
  message_id      Int       @id @default(autoincrement())
  sender_id       Int
  receiver_id     Int
  content         String
  is_deleted      Boolean   @default(false)
  is_edited       Boolean   @default(false)
  is_read         Boolean   @default(false)  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  sender          User @relation("SentMessages", fields: [sender_id], references: [user_id], onDelete: Cascade)
  receiver        User @relation("ReceivedMessages", fields: [receiver_id], references: [user_id], onDelete: Cascade)
  
  @@index([sender_id])
  @@index([receiver_id])
  @@index([createdAt])
  @@index([receiver_id, is_read])  
}

model Block {
  block_id        Int      @id @default(autoincrement())
  blocker_id      Int
  blocked_id      Int
  createdAt       DateTime @default(now())
  
  blocker         User @relation("BlockedUsers", fields: [blocker_id], references: [user_id], onDelete: Cascade)
  blocked         User @relation("BlockedBy", fields: [blocked_id], references: [user_id], onDelete: Cascade)
  
  @@unique([blocker_id, blocked_id])
  @@index([blocker_id])
  @@index([blocked_id])
}

model Alert {
  alert_id       Int       @id @default(autoincrement())
  user_id        Int
  actor_id       Int
  type           AlertType
  review_id      Int?
  comment_id     Int?
  book_id        Int?
  thread_id      Int?           
  thread_comment_id Int?        
  is_read        Boolean   @default(false)
  createdAt      DateTime  @default(now())
  
  user           User          @relation("AlertsReceived", fields: [user_id], references: [user_id], onDelete: Cascade)
  actor          User          @relation("AlertsCreated", fields: [actor_id], references: [user_id], onDelete: Cascade)
  review         Review?       @relation(fields: [review_id], references: [review_id], onDelete: Cascade)
  comment        ReviewComment? @relation(fields: [comment_id], references: [comment_id], onDelete: Cascade)
  book           Book?         @relation(fields: [book_id], references: [book_id], onDelete: Cascade)
  thread         Thread?       @relation(fields: [thread_id], references: [thread_id], onDelete: Cascade)
  threadComment  ThreadComment? @relation(fields: [thread_comment_id], references: [comment_id], onDelete: Cascade)
  
  @@index([user_id, is_read])
  @@index([user_id, createdAt])
}

enum AlertType {
  FOLLOWING_REVIEWED
  FOLLOWING_COMMENTED
  COMMENT_ON_YOUR_REVIEW
  THREAD_COMMENT           
  FOLLOWED_USER_THREAD     
}


model Thread {
  thread_id       Int      @id @default(autoincrement())
  user_id         Int
  title           String
  content         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  comments        ThreadComment[]
  followers       ThreadFollow[]
  alerts          Alert[]            
  
  @@index([user_id])
  @@index([createdAt])
}

model ThreadComment {
  comment_id      Int      @id @default(autoincrement())
  thread_id       Int
  user_id         Int
  content         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  thread          Thread @relation(fields: [thread_id], references: [thread_id], onDelete: Cascade)
  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  alerts          Alert[]              
  
  @@index([thread_id])
  @@index([user_id])
}


model ThreadFollow {
  follow_id       Int      @id @default(autoincrement())
  user_id         Int
  thread_id       Int
  createdAt       DateTime @default(now())
  
  user            User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  thread          Thread @relation(fields: [thread_id], references: [thread_id], onDelete: Cascade)
  
  @@unique([user_id, thread_id])
  @@index([user_id])
  @@index([thread_id])
}